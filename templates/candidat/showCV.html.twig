{% extends 'page.html.twig' %}
{% block title %}Voir un CV{% endblock %}
{% block body %}
    <div style="position: relative" class="ui text justified container">
        {% if not owner %}
            <a href="{{ path('entreprise_cvs') }}" class="ui compact labeled icon button"
               style="position: absolute; top: 20px; left: -20px; transform: translateX(-100%);">
                <i class="left arrow icon"></i>
                Retour aux CV
            </a>
        {% endif %}
        <h2 class="ui center aligned icon header">
            <i class="address card outline icon"></i>
            CV de {{ cv.employe.prenom }} {{ cv.employe.nom }}
        </h2>
        <div>
            <div class="ui buttons">
                <a download="CV de Jean Valjean" href="{{ asset('img/placeholders/cv.png') }}"
                   class="ui grey basic button">
                    Télécharger
                </a>
                {% if owner %}
                    <a href="{{ path('entreprise_modifier_cv', {id: cv.id}) }}"
                       class="ui blue basic button">
                        Éditer
                    </a>
                    <a href="{{ path('entreprise_delete_cv', {id: cv.id}) }}"
                       class="ui red basic button">
                        Supprimer
                    </a>
                {% endif %}
            </div>
        </div>
        <form class="ui form segment">
            <!-- Identité -->
            <h3 class="ui dividing header">
                <i class="icon user"></i>
                <div class="content">Identité</div>
            </h3>
            <div class="ui two column grid">
                <div class="column four wide">
                    {% if cv.employe.photo is not empty %}
                        <div class="profileLogo profileLogo--120"
                             style="background-image: url('{{ asset('uploads/photo/' ~ cv.employe.photo) }}'); -moz-background-image: url('{{ asset('uploads/photo/' ~ cv.employe.photo) }}'); -o-background-image: url('{{ asset('uploads/photo/' ~ cv.employe.photo) }}'); -webkit-background-image: url('{{ asset('uploads/photo/' ~ cv.employe.photo) }}');"></div>
                    {% else %}
                        <img src="{{ asset('img/placeholders/matthew.png') }}"
                             alt="photo de profil"
                             class="ui small circular image">
                    {% endif %}
                </div>
                <div class="column ten wide">
                    <div>{{ cv.employe.prenom }} {{ cv.employe.nom }}</div>
                    <div>Homme</div>
                    <div>Né le {{ cv.naissance|date('d/m/Y') }}</div>
                    <div>{{ cv.situationFamille.nom }}</div>
                    <div class="ui divider"></div>
                    {% if app.session.get('user') %}
                        <div>{{ cv.employe.email }}</div>
                        <div>{{ cv.employe.telephone }}</div>
                    {% endif %}
                </div>
            </div>
            <!-- Formation -->
            {% if cv.diplomes is not empty %}
                <h3 class="ui dividing header">
                    <i class="icon university"></i>
                    <div class="content">Formation</div>
                </h3>
                <div class="ui segments">
                    {% for diplome in cv.diplomes %}
                        <div class="ui segment formation1">
                            <h4 class="ui header">{{ diplome.diplome.nom }} à {{ diplome.diplome.etablissement }}</h4>
                            <div>{{ diplome.date|date('d/m/Y') }}</div>
                            <div>{{ diplome.mention }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <!-- Expérience -->
            {% if cv.metiers is not empty %}
                <h3 class="ui dividing header">
                    <i class="icon dolly"></i>
                    <div class="content">Expérience professionnelle</div>
                </h3>
                <div class="ui segments">
                    {% for metier in cv.metiers %}
                        <div class="ui segment">
                            <h4 class="ui header">{{ metier.metier.nom }} chez {{ metier.metier.nomEntreprise }}</h4>
                            <div>Du {{ metier.dateDebut|date('d/m/Y') }} au {{ metier.dateFin|date('d/m/Y') }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <!-- Bio -->
            {% if cv.description %}
                <h3 class="ui dividing header">
                    <i class="icon info"></i>
                    <div class="content">Biographie</div>
                </h3>
                <div class="ui segment">
                    <p>{{ cv.description|nl2br }}</p>
                </div>
            {% endif %}
            <!-- Langues parlées -->
            <h3 class="ui dividing header">
                <i class="icon globe"></i>
                <div class="content">Langues parlées</div>
            </h3>
            <ul>
                {% for langue in cv.langues %}
                    <li>{{ langue.langue.nom }} - {{ langue.niveau }}</li>
                {% endfor %}
            </ul>
            <!-- Compétences -->
            {% if cv.competences is not empty %}
                <h3 class="ui dividing header">
                    <i class="icon settings"></i>
                    <div class="content">Compétences</div>
                </h3>
                <ul>
                    {% for competence in cv.competences %}
                        <li>{{ competence.competence.nom }} - {{ competence.niveau }} / 5</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <!-- Autres -->
            <h3 class="ui dividing header">
                <i class="icon question circle outline"></i>
                <div class="content">Autres informations</div>
            </h3>
            <div class="ui segment">
                <div class="ui left float icon">
                    <i class="icon {% if cv.permis %}check{% else %}times{% endif %}"></i>
                    Dispose du permis B
                </div>
                <div class="ui left float icon">
                    <i class="icon {% if cv.permis %}check{% else %}times{% endif %}"></i>
                    Dispose d'un moyen de transport
                </div>
            </div>
        </form>
        {% if app.session.get('userType') == 'Employeur' %}
            <button id="applyBtn" class="ui green button" onclick="offreContrat()">
                Recruter
            </button>
        {% endif %}
    </div>
{% endblock %}
{% block javascripts %}
    <script type="text/javascript">
        if (httpRequest == undefined) {
            let httpRequest
        }
        if (results == undefined) {
            let results
        }

        function offreContrat() {
            httpRequest = new XMLHttpRequest();

            if (!httpRequest) {
                alert('Abandon :( Impossible de créer une instance de XMLHTTP');
                return false;
            }
            httpRequest.onreadystatechange = offreContratResponse;
            let idOffreEmploi = 42
            httpRequest.open('POST', '/entreprise/propose/' + idOffreEmploi + '/{{ cv.employe.identity }}');
            httpRequest.send();
        }

        const applyBtn = document.querySelector("#applyBtn")

        function offreContratResponse() {
            //En cours de chargement
            if (httpRequest.readyState === XMLHttpRequest.LOADING) {
                applyBtn.innerHTML = `<i class="notched circle loading icon"></i>`;
            }
            //Chargé
            else if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    // stocke les résultats parsé en JSON dans une variable
                    results = JSON.parse(httpRequest.responseText)
                    console.log(results)
                    // Candidature posée
                    if (results.result) {
                        applyBtn.innerHTML = '<div>Validé</div>';
                    }
                    // Candidature retirée
                    else {
                        applyBtn.innerHTML = '<div>Déjà demandé</div>';
                    }
                } else {
                    applyBtn.innerHTML = `<div>Il y a eu un problème avec la requête.</div>`;
                }
            }
        }
    </script>
{% endblock %}